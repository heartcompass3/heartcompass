---
import BaseLayout from '../../layouts/BaseLayout.astro'
import PortableText from '../../components/PortableText.astro'
import { sanity } from '../../lib/sanity'
import site from '../../content/pages/site.json'

const { slug } = Astro.params

// מחפשים דף לפי שלוש אפשרויות כדי לתפוס גם תצורות שונות של slugs
const page = await sanity.fetch(
  `*[_type=="page" && (
      slug.current == $plain
      || slug.current == $prefixed
      || slug.current == $methodOld
    )][0]{
    title,
    excerpt,
    body,
    seo{
      title,
      description,
      canonical,
      noindex,
      ogImage{ asset->{url} }
    }
  }`,
  {
    plain: slug,
    prefixed: `specialties/${slug}`,
    methodOld: `method/${slug}`,
  }
)

if (!page) {
  return new Response(null, { status: 404 })
}

const title = page?.seo?.title || page.title || `מצפן הלב | ${site.brand}`
const description = page?.seo?.description || page.excerpt || ''
const canonical = page?.seo?.canonical || undefined
const noindex = page?.seo?.noindex || false
const ogImage = page?.seo?.ogImage?.asset?.url || undefined
const body = Array.isArray(page?.body) ? page.body : []
---

<BaseLayout title={title} description={description} canonical={canonical} noindex={noindex} ogImage={ogImage}>
  <section class="container mx-auto px-6 py-16">
    <header class="max-w-4xl mx-auto text-center">
      <h1 class="text-4xl md:text-5xl font-black text-primary font-display leading-tight">
        {page.title}
      </h1>

      {page.excerpt && (
        <p class="mt-5 text-lg md:text-xl text-primary/70 font-body leading-relaxed">
          {page.excerpt}
        </p>
      )}
    </header>

    <article class="max-w-4xl mx-auto mt-12 bg-white rounded-[36px] border border-foreground/5 shadow-lg p-8 md:p-12">
      <div class="prose prose-lg max-w-none prose-headings:font-display prose-p:font-body prose-p:text-foreground/80 prose-a:text-accent">
        <PortableText value={body} />
      </div>
    </article>
  </section>
</BaseLayout>

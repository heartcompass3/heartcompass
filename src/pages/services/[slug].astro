---
import BaseLayout from '../../layouts/BaseLayout.astro'
import PortableText from '../../components/PortableText.astro'
import site from '../../content/pages/site.json'
import { sanity, urlFor } from '../../lib/sanity'
import { buildBreadcrumbListSchema } from '../../lib/breadcrumbs'

const { slug } = Astro.params

const doc = await sanity.fetch(
  `*[_type=="service" && slug.current==$slug][0]{
    title,
    subtitle,
    lead,
    body,
    seo{
      title,
      description,
      noindex,
      canonical,
      ogImage
    }
  }`,
  { slug }
)

if (!doc) return new Response('Not found', { status: 404 })

const ogImage = doc?.seo?.ogImage
  ? urlFor(doc.seo.ogImage).width(1200).height(630).url()
  : undefined

const title = doc?.seo?.title || doc.title
const description = doc?.seo?.description || doc.lead || undefined
const canonical = doc?.seo?.canonical || new URL(Astro.url.pathname, site.siteUrl).toString()
const noindex = doc?.seo?.noindex || false

const breadcrumbSchema = buildBreadcrumbListSchema({
  siteUrl: site.siteUrl,
  brandName: site.brand,
  crumbs: [
    { name: doc.title, item: canonical },
  ],
})

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  '@id': `${canonical}#service`,
  name: doc.title,
  description: description || undefined,
  url: canonical,
  provider: {
    '@type': 'Person',
    name: site.fullName,
  },
  areaServed: 'IL',
}
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonical}
  noindex={noindex}
  ogImage={ogImage}
  schema={[serviceSchema, breadcrumbSchema]}
>
  <main class="mx-auto max-w-5xl px-4 py-10">
    <h1 class="text-3xl font-bold">{doc.title}</h1>
    {doc.subtitle && <h2 class="mt-3 text-xl text-muted-foreground">{doc.subtitle}</h2>}
    {doc.lead && <p class="mt-4">{doc.lead}</p>}
    <div class="prose prose-zinc mt-8 max-w-none">
      <PortableText value={doc.body} />
    </div>
  </main>
</BaseLayout>

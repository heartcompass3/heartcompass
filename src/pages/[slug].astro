---
import BaseLayout from '../layouts/BaseLayout.astro'
import { sanity } from '../lib/sanity'
import PortableText from '../components/PortableText.astro'

const parts = Array.isArray(Astro.params.slug)
  ? Astro.params.slug
  : [Astro.params.slug].filter(Boolean)

const slug = parts.join('/')

// מושכים דף לפי slug
const page = await sanity.fetch(
  `*[_type=="page" && slug.current == $slug][0]{
    title,
    excerpt,
    body,
    seo{
      title,
      description,
      canonical,
      noindex,
      ogImage{
        asset->{url}
      }
    }
  }`,
  { slug }
)

if (!page) {
  return new Response('Not found', { status: 404 })
}

const title = page?.seo?.title || page.title
const description = page?.seo?.description || page.excerpt || ''
const canonical = page?.seo?.canonical || undefined
const noindex = page?.seo?.noindex || false
const ogImage = page?.seo?.ogImage?.asset?.url || undefined

// הגנה: אם אין body, לא מפילים את PortableText
const body = Array.isArray(page?.body) ? page.body : []
---

<BaseLayout title={title} description={description} canonical={canonical} noindex={noindex} ogImage={ogImage}>
  <section class="container mx-auto px-6 py-16">
    <header class="max-w-4xl mx-auto text-center">
      <h1 class="text-4xl md:text-5xl font-black text-primary font-display leading-tight">
        {page.title}
      </h1>

      {page.excerpt && (
        <p class="mt-5 text-lg md:text-xl text-primary/70 font-body leading-relaxed">
          {page.excerpt}
        </p>
      )}
    </header>

    <article class="max-w-4xl mx-auto mt-12 bg-white rounded-[36px] border border-foreground/5 shadow-lg p-8 md:p-12">
      <div class="prose prose-lg max-w-none prose-headings:font-display prose-p:font-body prose-p:text-foreground/80 prose-a:text-accent">
        <PortableText value={body} />
      </div>
    </article>
  </section>
</BaseLayout>

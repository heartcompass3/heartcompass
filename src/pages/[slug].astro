---
import BaseLayout from '../layouts/BaseLayout.astro'
import { sanity } from '../lib/sanity'

// slug מגיע כ-array: ["method","couples"] וכו'
const slugParts = Astro.params.slug ? Astro.params.slug.split('/') : []
const slug = slugParts.join('/')

// דף בית: אם מגיעים ל- "/" אז slug יהיה ריק
const effectiveSlug = slug || 'home'

// מושכים דף לפי slug
const page = await sanity.fetch(
  `*[_type=="page" && slug.current == $slug][0]{
    title,
    excerpt,
    body,
    seo
  }`,
  { slug: effectiveSlug }
)

// אם אין דף בסאניטי — מחזירים 404 אמיתי
if (!page) {
  return new Response('Not found', { status: 404 })
}

// רינדור מינימלי ל-body (Portable Text בסיסי)
const renderBlocks = (blocks = []) => {
  return blocks
    .filter(b => b?._type === 'block' && Array.isArray(b.children))
    .map(b => b.children.map(c => c.text).join(''))
    .filter(Boolean)
}
const paragraphs = renderBlocks(page.body)
---

<BaseLayout title={page?.seo?.title || page.title} description={page?.seo?.description || page.excerpt || ''}>
  <main class="max-w-5xl mx-auto px-6 lg:px-8 py-12">
    <h1 class="text-4xl md:text-5xl font-black text-primary font-display leading-tight">
      {page.title}
    </h1>

    {page.excerpt && (
      <p class="mt-4 text-lg md:text-xl text-primary/70 font-body leading-relaxed">
        {page.excerpt}
      </p>
    )}

    <div class="mt-10 space-y-6">
      {paragraphs.map((p) => (
        <p class="text-lg text-primary/80 font-body leading-relaxed">
          {p}
        </p>
      ))}
    </div>
  </main>
</BaseLayout>

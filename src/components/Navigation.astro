---
import site from '../content/pages/site.json'
import { sanity } from '../lib/sanity'

const currentPath = Astro.url.pathname

// 1) מביאים תפריט ראשי מהגדרות אתר (אם קיים)
const settings = await sanity.fetch(
  `*[_type=="siteSettings"][0]{ nav[]{ label, href, children[]{ label, href } } }`
)

// 2) מביאים אוטומטית את דפי השיטה לפי slug method/*
const methodPages = await sanity.fetch(
  `*[_type=="page" && defined(slug.current) && slug.current match "method/*"]{
    title,
    "slug": slug.current,
    "href": "/" + slug.current
  } | order(slug asc)`
)

const normalizeHref = (href) => {
  if (!href) return ''
  const raw = String(href).trim()

  // URL מלא -> pathname
  if (raw.startsWith('http://') || raw.startsWith('https://')) {
    try {
      return new URL(raw).pathname || '/'
    } catch {
      return '/'
    }
  }

  // פנימי בלי / -> נוסיף /
  if (!raw.startsWith('/')) return '/' + raw

  // ניקוי כפילות // בתחילת נתיב
  return raw.replace(/^\/+/, '/')
}

const isActive = (href) => {
  if (!href) return false
  if (href === '/') return currentPath === '/'
  return currentPath === href || currentPath.startsWith(href + '/')
}

// nav מהגדרות אתר (אם אין – יהיה ריק)
const rawNav = (settings?.nav ?? [])
  .map((item) => ({
    ...item,
    href: normalizeHref(item.href),
    children: (item.children ?? [])
      .map((c) => ({ ...c, href: normalizeHref(c.href) }))
      .filter((c) => c?.label && c?.href),
  }))
  .filter((i) => i?.label && i?.href)

// children אוטומטי מה-pages method/*
const autoMethodChildren = (methodPages ?? [])
  .filter((p) => p?.title && p?.href && p?.slug)
  // מוציאים את דף האב (method) אם יש טעות והוא נכנס לרשימה
  .filter((p) => p.slug !== 'method')
  .map((p) => ({ label: p.title, href: normalizeHref(p.href) }))

// מזהים את פריט "השיטה": /method
const METHOD_PARENT_HREF = '/method'

// מעדכנים את פריט "השיטה" הקיים כך שייקח children אוטומטי
let nav = rawNav.map((item) => {
  if (normalizeHref(item.href) === METHOD_PARENT_HREF) {
    return { ...item, href: METHOD_PARENT_HREF, children: autoMethodChildren }
  }
  return item
})

// אם אין בכלל "השיטה" בתפריט – נוסיף
const hasMethodItem = nav.some((i) => normalizeHref(i.href) === METHOD_PARENT_HREF)
if (!hasMethodItem) {
  nav = [...nav, { label: 'השיטה', href: METHOD_PARENT_HREF, children: autoMethodChildren }]
}

// ניקוי כפילויות לפי href
const seen = new Set()
nav = nav.filter((item) => {
  const href = normalizeHref(item?.href)
  if (!href) return false
  if (seen.has(href)) return false
  seen.add(href)
  return true
})
---

<nav class="sticky top-0 z-[100] glass border-b border-accent/20 shadow-sm w-full">
  <div class="max-w-7xl mx-auto px-6 lg:px-8">
    <div class="flex justify-between items-center h-20 md:h-24">

      <a href="/" class="flex items-center gap-4 group focus:outline-none" aria-label="חזרה לדף הבית">
        <div class="relative w-12 h-12 md:w-14 md:h-14 shrink-0 transition-transform duration-500 group-hover:rotate-[30deg]">
          <div class="w-full h-full rounded-full gradient-gold flex items-center justify-center p-[2px] shadow-lg">
            <div class="w-full h-full rounded-full bg-white flex items-center justify-center border border-accent/30">
              <img
                src="/assets/logo.png"
                alt="לוגו מצפן הלב"
                loading="eager"
                class="h-9 md:h-10 w-auto object-contain drop-shadow-sm"
              />
            </div>
          </div>
        </div>

        <div class="flex flex-col justify-center h-full items-start">
          <span class="text-2xl md:text-3xl font-black text-primary font-display leading-none tracking-tight drop-shadow-sm">{site.brand}</span>
          <span class="text-xs md:text-sm text-gold-dark font-body font-bold tracking-widest mt-0.5 whitespace-nowrap">{site.tagline}</span>
        </div>
      </a>

      <!-- Desktop nav -->
      <div class="hidden md:flex items-center gap-8 lg:gap-10">
        {nav.map((item) => {
          const hasChildren = Array.isArray(item.children) && item.children.length > 0
          const active = isActive(item.href)

          return hasChildren ? (
            <div class="relative group">
              <a
                href={item.href}
                class={`text-lg font-bold transition-all duration-300 font-body relative px-2 py-1 outline-none ${
                  active ? 'text-primary' : 'text-primary/70 hover:text-accent'
                }`}
              >
                {item.label}
              </a>

              <div class="absolute right-0 top-full pt-3 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-opacity z-[200]">
                <div class="w-[320px] rounded-2xl bg-white shadow-elegant border border-accent/15">
                  <div class="p-3">
                    {item.children.map((child) => (
                      <a
                        href={child.href}
                        class={`block px-4 py-3 rounded-xl hover:bg-accent/5 font-body font-bold transition-colors ${
                          isActive(child.href) ? 'text-primary' : 'text-primary/80 hover:text-primary'
                        }`}
                      >
                        {child.label}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <a
              href={item.href}
              class={`text-lg font-bold transition-all duration-300 font-body relative px-2 py-1 outline-none ${
                active ? 'text-primary' : 'text-primary/70 hover:text-accent'
              }`}
            >
              {item.label}
            </a>
          )
        })}
      </div>

      <!-- Mobile nav -->
      <details class="md:hidden">
        <summary class="list-none text-primary p-2 hover:bg-accent/10 rounded-xl transition-colors cursor-pointer select-none">
          <span class="sr-only">תפריט</span>
          <span class="text-3xl">☰</span>
        </summary>

        <div class="bg-white border-t border-accent/20 absolute top-full left-0 w-full shadow-2xl z-[200] animate-fade-in">
          <div class="px-6 py-6 space-y-2 flex flex-col">
            {nav.map((item) => {
              const hasChildren = Array.isArray(item.children) && item.children.length > 0

              return hasChildren ? (
                <div class="pt-2">
                  <div class="text-sm font-bold text-primary/60 px-4 py-2">{item.label}</div>
                  {item.children.map((child) => (
                    <a
                      href={child.href}
                      class={`w-full text-right px-4 py-3 rounded-xl text-lg font-bold border-b border-accent/10 transition-colors hover:bg-accent/5 ${
                        isActive(child.href) ? 'text-primary' : ''
                      }`}
                    >
                      {child.label}
                    </a>
                  ))}
                </div>
              ) : (
                <a
                  href={item.href}
                  class={`w-full text-right px-4 py-4 rounded-xl text-xl font-bold border-b border-accent/10 transition-colors hover:bg-accent/5 ${
                    isActive(item.href) ? 'text-primary' : ''
                  }`}
                >
                  {item.label}
                </a>
              )
            })}
          </div>
        </div>
      </details>

    </div>
  </div>
</nav>

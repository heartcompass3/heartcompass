---
import { sanity } from '../lib/sanity'
import { SITE_SETTINGS_QUERY } from '../lib/sanityQueries'

const settings = await sanity.fetch(SITE_SETTINGS_QUERY)

// קישור בסיס לוואטסאפ (חי מהסאניטי אם קיים)
const baseHref =
  settings?.whatsapp?.href ||
  settings?.whatsappPrimaryHref ||
  'https://wa.me/972544580285'

// Warmups מהסאניטי אם יהיה בעתיד שדה כזה (whatsappWarmups)
// אם לא קיים – fallback קשיח כדי שלא ייעלם
const warmups =
  Array.isArray(settings?.whatsappWarmups) && settings.whatsappWarmups.length > 0
    ? settings.whatsappWarmups
        .filter((w) => w?.label && w?.message)
        .slice(0, 3)
    : [
        { label: 'אני תקוע/ה בדפוס שחוזר', message: 'היי יוסי, אני מרגיש/ה תקוע/ה בדפוס שחוזר על עצמו. אפשר לשאול כמה שאלות?' },
        { label: 'זוגיות שמפעילה אותי', message: 'היי יוסי, יש לי עניין בזוגיות שמפעיל אותי רגשית. אשמח להבין אם זה מתאים לתהליך איתך.' },
        { label: 'כיוון בקריירה ובחיים', message: 'היי יוסי, אני מרגיש/ה בלבול לגבי כיוון בקריירה ובחיים. אפשר לשמוע איך אתה עובד?' },
      ]

const buildWhatsAppLink = (msg) => {
  if (!msg) return baseHref
  const sep = baseHref.includes('?') ? '&' : '?'
  return `${baseHref}${sep}text=${encodeURIComponent(msg)}`
}

const whatsappSvg = `
<svg viewBox="0 0 32 32" width="26" height="26" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path fill="currentColor" d="M16 3C9.4 3 4 8.3 4 14.8c0 2.2.6 4.2 1.8 6L4 29l8.4-1.8c1.1.3 2.3.5 3.6.5 6.6 0 12-5.3 12-11.9S22.6 3 16 3Zm0 21.6c-1.2 0-2.3-.2-3.3-.6l-.6-.2-5 1.1 1.1-4.8-.3-.6c-1-1.6-1.6-3.4-1.6-5.4C6.3 9.3 10.7 5 16 5s9.7 4.3 9.7 9.6-4.4 10-9.7 10Z"/>
  <path fill="currentColor" d="M22.1 18.4c-.3-.1-1.7-.8-2-.9-.3-.1-.5-.1-.7.2-.2.3-.8.9-1 .9-.2.1-.4.1-.7-.1-.3-.1-1.2-.4-2.3-1.4-.9-.8-1.5-1.8-1.7-2.1-.2-.3 0-.5.1-.6l.5-.6c.2-.2.2-.4.3-.6.1-.2 0-.4 0-.6-.1-.1-.7-1.7-1-2.3-.3-.6-.6-.5-.8-.5h-.7c-.2 0-.5.1-.7.4-.2.3-1 1-1 2.4 0 1.4 1 2.7 1.1 2.9.1.2 2 3 4.9 4.2.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.4.2-.7.2-1.3.2-1.4 0-.1-.3-.2-.6-.3Z"/>
</svg>
`
---

<div class="fixed bottom-6 left-6 z-[150]" data-wa-root>
  <!-- Warmups bubble -->
  <div
    class="hidden mb-3 w-72 rounded-2xl bg-white shadow-elegant border border-accent/10 overflow-hidden"
    data-wa-panel
    aria-hidden="true"
  >
    <div class="px-4 pt-4 pb-3 border-b border-accent/10">
      <div class="font-body font-bold text-foreground">מה בא לך לכתוב?</div>
      <div class="font-body text-sm text-muted-foreground mt-1">בחר שאלה ונפתח הודעה מוכנה</div>
    </div>

    <div class="p-3 flex flex-col gap-2">
      {warmups.map((w) => (
        <a
          href={buildWhatsAppLink(w.message)}
          target="_blank"
          rel="noopener noreferrer"
          class="px-3 py-2 rounded-xl bg-accent/10 hover:bg-accent/15 transition font-body text-sm text-foreground"
        >
          {w.label}
        </a>
      ))}

      <a
        href={baseHref}
        target="_blank"
        rel="noopener noreferrer"
        class="px-3 py-2 rounded-xl border border-accent/15 hover:bg-accent/5 transition font-body text-sm text-foreground"
      >
        לפתוח וואטסאפ בלי שאלה
      </a>
    </div>
  </div>

  <!-- Floating WhatsApp round button -->
  <button
    type="button"
    class="w-14 h-14 rounded-full bg-[#25D366] text-white shadow-elegant hover:brightness-95 transition flex items-center justify-center"
    data-wa-button
    aria-label="פתח וואטסאפ"
    aria-expanded="false"
  >
    <span class="w-7 h-7" set:html={whatsappSvg}></span>
  </button>

  <script is:inline>
    (() => {
      const root = document.querySelector('[data-wa-root]');
      if (!root) return;

      const btn = root.querySelector('[data-wa-button]');
      const panel = root.querySelector('[data-wa-panel]');

      const close = () => {
        if (!panel || !btn) return;
        panel.classList.add('hidden');
        panel.setAttribute('aria-hidden', 'true');
        btn.setAttribute('aria-expanded', 'false');
      };

      const open = () => {
        if (!panel || !btn) return;
        panel.classList.remove('hidden');
        panel.setAttribute('aria-hidden', 'false');
        btn.setAttribute('aria-expanded', 'true');
      };

      const toggle = () => {
        if (!panel) return;
        panel.classList.contains('hidden') ? open() : close();
      };

      if (btn) {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggle();
        });
      }

      if (panel) panel.addEventListener('click', (e) => e.stopPropagation());

      document.addEventListener('click', close);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
      });
      document.addEventListener('astro:after-swap', close);
    })();
  </script>
</div>
